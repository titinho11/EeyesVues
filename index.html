<!DOCTYPE html>
<html lang='en'>
    <head>
        <!-- META SECTION -->
        <title>Election's Eyes</title>            
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <link rel="icon" href="favicon.ico" type="image/x-icon" />
        <!-- END META SECTION -->

        <!-- CSS INCLUDE -->        
        <link rel="stylesheet" type="text/css" id="theme" href="css/theme-default.css"/>
        <!-- EOF CSS INCLUDE -->  
        
    </head>
    <body>
        <!-- START PAGE CONTAINER -->
        <div class="page-container">
            
            <!-- START PAGE SIDEBAR -->
            <div class="page-sidebar" id="sidebar">
                <!-- START X-NAVIGATION -->
                <ul class="x-navigation">
                        <li class="xn-logo">
                            <a href="index.html">Election's<span class="fa fa-eye"></span></a>
                            <a href="#" class="x-navigation-control"></a>
                        </li>
                        <li class="xn-title">Navigation</li>
                        <li class="active">
                            <a href="index.html"><span class="fa fa-desktop"></span> <span class="xn-text">Accueil</span></a>                        
                        </li>                    
                        <li class="lien">
                            <a href="Bureau_vote.html"><span class="fa fa-th"></span> <span class="xn-text">Sections</span></a>
                        </li>                  
                    </ul>
                
                    
                    <!-- END X-NAVIGATION -->
            </div>
            <!-- END PAGE SIDEBAR -->
            
            <!-- PAGE CONTENT -->
            <div class="page-content">
                <div id="sup_nav"></div>
                <!-- START X-NAVIGATION VERTICAL -->
                <ul class="x-navigation x-navigation-horizontal x-navigation-panel">
                        <!-- TOGGLE NAVIGATION -->
                        <li class="xn-icon-button">
                            <a href="#" class="x-navigation-minimize"><span class="fa fa-dedent"></span></a>
                        </li>
                        <!-- END TOGGLE NAVIGATION -->
                        <!-- SEARCH -->
                        <li class="xn-icon-button">
                            <div id="titre"></div>
                        </li>
                        <!-- END SEARCH -->
                        <!-- MESSAGES -->
                        <li class="xn-icon-button pull-right">
                            <a href="#"><span class="fa fa-upload"></span></a>
                            <div class="panel panel-primary animated zoomIn xn-drop-left xn-panel-dragging">
                                <div class="panel-heading">
                                    <h3 class="panel-title"><span class="fa fa-upload"></span>Upload PV</h3>                                
                                </div>
                                <div class="panel-body" style="height: 400px;">
                                        <h3><span class="fa fa-mail-forward"></span> Upload le PV d'un Bureau</h3>
                                        <p>Choisir l'image de PV à importer et cliquer sur Upload</p>                                    
                                        <form enctype="multipart/form-data" class="form-horizontal" onsubmit="return send()">                                         
                                            <div class="form-group">
                                                <div class="col-md-12">
                                                    <label>Default</label>
                                                    <input type="file" class="file" id="pv" data-preview-file-type="any"/>
                                                </div>
                                            </div>
                                        </form>
                                </div>                               
                            </div>                        
                        </li>
                        <!-- END MESSAGES -->
                    </ul>
                    <!-- END X-NAVIGATION VERTICAL -->                      
                <div id="page_content">
                <!-- START BREADCRUMB -->
                <ul class="breadcrumb">
                    <li><a href="#">Accueil</a></li>                    
                    <li class="active">index</li>
                </ul>
                    <!-- END BREADCRUMB -->  
                <!-- PAGE CONTENT WRAPPER -->
                <div class="page-content-wrap">
                                    

                    <div class= "row" >
                        <h1 style="padding:15dp; text-align: center; text-decoration-style: solid; color: #1b1e24; font-weight: bold;" id= "session_title"></h1>
                    </div>

                    <!-- START WIDGETS -->  
                    <div class="row">
                        <div class="col-md-8">
                            <div class="row">
                                <div class="col-md-6">
                            
                                    <!-- START WIDGET MESSAGES -->
                                    <div class="widget widget-default widget-item-icon">
                                        <div class="widget-item-left">
                                            <span class="fa fa-file"></span>
                                        </div>                             
                                        <div class="widget-data">
                                            <div class="widget-int num-count" id = "pv_attendu"></div>
                                            <div class="widget-title">PVs</div>
                                            <div class="widget-subtitle">Attendus</div>
                                        </div>  
                                    </div>                            
                                    <!-- END WIDGET MESSAGES -->
                                    
                                </div>
                                <div class="col-md-6">
                                    
                                    <!-- START WIDGET REGISTRED -->
                                    <div class="widget widget-default widget-item-icon">
                                        <div class="widget-item-left">
                                            <span class="fa fa-paperclip"></span>
                                        </div>
                                        <div class="widget-data">
                                            <div class="widget-int num-count" id="pv_recu"></div>
                                            <div class="widget-title">Pvs</div>
                                            <div class="widget-subtitle">Recus</div>
                                        </div>                           
                                    </div>                            
                                    <!-- END WIDGET REGISTRED -->
                                    
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                            
                                    <!-- START WIDGET MESSAGES -->
                                    <div class="widget widget-default widget-item-icon">
                                        <div class="widget-item-left">
                                            <span class="fa fa-users"></span>
                                        </div>                             
                                        <div class="widget-data">
                                            <div class="widget-int num-count" id="electeurs"></div>
                                            <div class="widget-title">Electeurs</div>
                                            <div class="widget-subtitle">Inscrits</div>
                                        </div>     
                                    </div>                            
                                    <!-- END WIDGET MESSAGES -->
                                    
                                </div>
                                <div class="col-md-6">
                                    
                                    <!-- START WIDGET MESSAGES -->
                                    <div class="widget widget-default widget-item-icon" onclick="location.href='pages-messages.html';">
                                        <div class="widget-item-left">
                                            <span class="fa fa-envelope"></span>
                                        </div>                             
                                        <div class="widget-data">
                                            <div class="widget-int num-count" id="voix"></div>
                                            <div class="widget-title">Suffrages</div>
                                            <div class="widget-subtitle">Exprimés</div>
                                        </div> 
                                    </div>                            
                                    <!-- END WIDGET MESSAGES -->
                                    
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <!-- START WIDGET CLOCK -->
                            <div class="widget widget-info widget-padding-sm">
                                <div class="widget-big-int plugin-clock">00:00</div>                            
                                <div class="widget-subtitle plugin-date">Loading...</div>
                                <div class="widget-controls">                                
                                    <a href="#" class="widget-control-right widget-remove" data-toggle="tooltip" data-placement="left" title="Remove Widget"><span class="fa fa-times"></span></a>
                                </div>                            
                                                          
                            </div>                        
                            <!-- END WIDGET CLOCK -->
                        </div>
                    </div>                  
                
                    <!-- END WIDGETS -->                    
                    
                    <div class="row">
                        <div class="col-md-8">
                            
                            <!-- START USERS ACTIVITY BLOCK -->
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <div class="panel-title-box">
                                        <h3>Resultats</h3>
                                        <span>Graphe des résultats finaux</span>
                                    </div>                                    
                                    <ul class="panel-controls" style="margin-top: 2px;">
                                        <li><a href="#" class="panel-fullscreen"><span class="fa fa-expand"></span></a></li>
                                        <li><a href="#" class="panel-refresh"><span class="fa fa-refresh"></span></a></li>
                                                                              
                                    </ul>                                    
                                </div>                                
                                <div class="panel-body padding-0">
                                    <div class="chart-holder" id="dashboard-bar-2" style="height: 200px;"></div>
                                </div>
                                <div class="panel-body padding-0">
                                    <div class="chart-holder" id="dashboard-bar-1" style="height: 0px;"></div>
                                </div>                                    
                            </div>
                            <!-- END USERS ACTIVITY BLOCK -->
                            
                        </div>
                        <div class="col-md-4">
                            
                            <!-- START VISITORS BLOCK -->
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <div class="panel-title-box">
                                        <h3>Résultats</h3>
                                        <span>Vrais Résultats</span>
                                    </div>
                                    <ul class="panel-controls" style="margin-top: 2px;">
                                        <li><a href="#" class="panel-fullscreen"><span class="fa fa-expand"></span></a></li>
                                        <li><a href="#" class="panel-refresh"><span class="fa fa-refresh"></span></a></li>
                                                                                
                                    </ul>
                                </div>
                                <div class="panel-body padding-0">
                                    <div class="chart-holder" id="dashboard-donut-2" style="height: 200px;"></div>
                                </div>
                                <div class="panel-body padding-0">
                                    <div class="chart-holder" id="dashboard-donut-1" style="height: 0px;"></div>
                                </div>
                            </div>
                            <!-- END VISITORS BLOCK -->
                            
                        </div>

                    </div>
                    
                
                    
                    <!-- START DASHBOARD CHART -->
                    <div class="chart-holder" id="dashboard-area-1" style="height: 0px;"></div>
                    <div class="block-full-width">
                                                                    
                    </div>                    
                    <!-- END DASHBOARD CHART -->
                        
                </div>
                    <!-- END PAGE CONTENT WRAPPER --> 
                                    
            </div>            
            <!-- END PAGE CONTENT -->
        </div>
        <!-- END PAGE CONTAINER -->


       

        <!-- Modal de l'aide -->

        <!-- info -->
        <div class="modal fade" id="largeModal" tabindex="-1" role="dialog" aria-labelledby="largeModal" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                      <h4 class="modal-title" id="myModalLabel">Candidat</h4>
                    </div>
                    <div class="modal-body">
                      <h3>Choisissez le candidat dont vous êtes le scrutateur</h3>
                      <div id="radioFragment"></div>
                      
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-default" data-dismiss="modal">Annuler</button>
                      <button type="button" class="btn btn-primary" onclick="preparer();">Envoyer</button>
                    </div>
                  </div>
                </div>
              </div>


        <!-- MESSAGE BOX-->
        <div class="message-box animated fadeIn" data-sound="alert" id="mb-signout">
            <div class="mb-container">
                <div class="mb-middle">
                    <div class="mb-title"><span class="fa fa-sign-out"></span> Log <strong>Out</strong> ?</div>
                    <div class="mb-content">
                        <p>Are you sure you want to log out?</p>                    
                        <p>Press No if youwant to continue work. Press Yes to logout current user.</p>
                    </div>
                    <div class="mb-footer">
                        <div class="pull-right">
                            <a href="pages-login.html" class="btn btn-success btn-lg">Yes</a>
                            <button class="btn btn-default btn-lg mb-control-close">No</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END MESSAGE BOX-->

        <!-- START PRELOADS -->
        <audio id="audio-alert" src="audio/alert.mp3" preload="auto"></audio>
        <audio id="audio-fail" src="audio/fail.mp3" preload="auto"></audio>
        <!-- END PRELOADS -->  
        <div id="scripts"></div>  
    </body>
    
    <!-- START SCRIPTS -->
        <!-- START PLUGINS -->
        <script type="text/javascript" src="js/plugins/jquery/jquery.min.js"></script>
        <script type="text/javascript" src="js/plugins/jquery/jquery-ui.min.js"></script>
        <script type="text/javascript" src="js/plugins/bootstrap/bootstrap.min.js"></script>        
        <!-- END PLUGINS -->

        <!-- START THIS PAGE PLUGINS-->        
        <script type='text/javascript' src='js/plugins/icheck/icheck.min.js'></script>        
        <script type="text/javascript" src="js/plugins/mcustomscrollbar/jquery.mCustomScrollbar.min.js"></script>
        <script type="text/javascript" src="js/plugins/scrolltotop/scrolltopcontrol.js"></script>
        
        <script type="text/javascript" src="js/plugins/morris/raphael-min.js"></script>
        <script type="text/javascript" src="js/plugins/morris/morris.min.js"></script>       
        <script type="text/javascript" src="js/plugins/rickshaw/d3.v3.js"></script>
        <script type="text/javascript" src="js/plugins/rickshaw/rickshaw.min.js"></script>
        <script type='text/javascript' src='js/plugins/jvectormap/jquery-jvectormap-1.2.2.min.js'></script>
        <script type='text/javascript' src='js/plugins/jvectormap/jquery-jvectormap-world-mill-en.js'></script>                
        <script type='text/javascript' src='js/plugins/bootstrap/bootstrap-datepicker.js'></script>                
        <script type="text/javascript" src="js/plugins/owl/owl.carousel.min.js"></script>                 
        
        <script type="text/javascript" src="js/plugins/moment.min.js"></script>
        <script type="text/javascript" src="js/plugins/daterangepicker/daterangepicker.js"></script>
        <!-- END THIS PAGE PLUGINS-->   
        
        <!--Burau de vote scripts-->
        <script type="text/javascript" src="js/plugins/bootstrap/bootstrap-timepicker.min.js"></script>
        <script type="text/javascript" src="js/plugins/bootstrap/bootstrap-colorpicker.js"></script>
        <script type="text/javascript" src="js/plugins/bootstrap/bootstrap-file-input.js"></script>
        <script type="text/javascript" src="js/plugins/bootstrap/bootstrap-select.js"></script>
        <script type="text/javascript" src="js/plugins/tagsinput/jquery.tagsinput.min.js"></script>
        <script type="text/javascript" src="js/plugins/sparkline/jquery.sparkline.min.js"></script>
        <script type="text/javascript" src="js/plugins/knob/jquery.knob.min.js"></script>
        <script type="text/javascript" src="js/plugins/fileinput/fileinput.min.js"></script> 
            

        <!--Bureau de vote scripts-->

        <!-- START TEMPLATE -->
        <script type="text/javascript" src="js/settings.js"></script>
        
        <script type="text/javascript" src="js/plugins.js"></script>        
        <script type="text/javascript" src="js/actions.js"></script>
        
        <script type="text/javascript" src="js/demo_dashboard.js"></script>
         
        <!-- END TEMPLATE -->
    <!-- END SCRIPTS --> 
    <script type="text/javascript" src="js/variable.js"></script> 
    <script type="text/javascript" src="js/hashMd5.js"></script> 
    <script type="text/javascript" src="js/lecturePV.js"></script> 
    <script type="text/javascript" src="js/ocr/ocrad.js"></script> 

    <script>

                
        

        var candidats = data[0].session.candidates;

        for(var i=0; i<candidats.length - 1; i++){
            createRadioElement(candidats[i]);
        }
        createRadioElement("ORGANISM");
        createRadioElement("AUTHENTIC");

        //alert("on envoie encore...");

            var pvcontent="";
            //variable qui contient l'image sous le format base64
            var picture = "";
     
             var allowedTypes = ['png', 'jpg', 'jpeg', 'gif'];
             var fileInput = document.querySelector('#pv');
     
     
             //Méthode appelé une fois qu'un fichier est selectionné
             document.querySelector('#pv').addEventListener('change', function() {
     
                 imgType = fileInput.files[0].name.split('.');
     
                 imgType = imgType[imgType.length - 1].toLowerCase(); // On utilise toLowerCase() pour éviter les extensions en majuscules
     
                 //On vérifie si le fichier selectionné est dans le bon format
                 if (allowedTypes.indexOf(imgType) != -1) {
     
                    var reader = new FileReader();
					reader.onload = function(){
						var img = new Image();
						img.src = reader.result;
						img.onload = function(){
                            alert("OCR processing, we will prevent you when done...");
							/*document.getElementById('nose').innerHTML = ''
							document.getElementById('nose').appendChild(img)*/
							OCRAD(img, function(text){
								/*document.getElementById('transcription').className = "done"
								document.getElementById('transcription').innerText = text;*/
								scrutateur = ""
								table = text.split('\n')
								console.log("****************")
								console.log(table)
								final = new Array();
								for (i=0; i<table.length; i++){
									if(!(table[i]==''||table[i]==' '||table[i]=='---')){
										final.push(table[i]);
									}
								}
								console.log(final);
								variable = {};
								variable["$class"] = "org.eeyes.ressources.ComputePV";
								variable["code"] = final[0].substring(8, final[0].length).replace(/-l/g,'-1')+":"+scrutateur;
								variable["BV"] = final[1].substring(15, final[1].length).replace(/-l/g,'-1');
								variable["sectionName"] = final[0].substring(8, final[0].length).replace(/-l/g,'-1');
								variable["nombreElecteursInscrits"] = parseInt(final[2].split(' ')[2]);
								variable["nombreSuffrageEmi"] = parseInt(final[3].split(' ')[3]);
								var today = new Date();
								var dd = today.getDate();
								var mm = today.getMonth()+1;
								var yyyy = today.getFullYear();

								if(dd<10) {
									dd = '0'+dd
								}

								if(mm<10) {
									mm = '0'+mm
								}

								var hour =  today.getHours();
								if(hour<10) {
									hour = '0'+hour
								}
								var minute = today.getMinutes();
								if(minute<10) {
									minute = '0'+minute
								}
								var second = today.getSeconds();
								if(second<10) {
									second = '0'+second
								}

								today = yyyy + '-' + mm + '-' + dd + 'T' + hour + ':' + minute + ':' + second;

								variable["publishedDate"] = today;
								variable["candidateVoices"] = new Array();

								for (i=5;i<final.length;i++){
									voice_temp = {};
									voice_temp["$class"] = "org.eeyes.ressources.Voices";
									tab_temp = final[i].split(" ");
									voice_temp["candidate"] = "";
									for (j=0; j<tab_temp.length-2;j++){
										voice_temp["candidate"] = voice_temp["candidate"]+tab_temp[j]+" ";
									}
									voice_temp["candidate"] = voice_temp["candidate"]+tab_temp[j];
									j = j+1;
									voice_temp["voice"] = parseInt(tab_temp[j].replace(/o/,'0').replace(/l/g,'1'));
									variable["candidateVoices"].push(voice_temp);
								}
								variable["scrutateur"] = "resource:org.eeyes.ressources.Author#"+scrutateur;

								console.log("variable apres ocr",variable);
                                alert("OCR done !");
                                pvcontent = variable;//send(variable);
                                loadModal();
                            })
						}
					}
					//reader.readAsDataURL(document.getElementById('picker').files[0])
                     
                     //évènement qui se déclenche une fois que le fichié est uploadé
                     /*reader.addEventListener('load', function() {
                         picture = reader.result;
                     });*/
                     //lecture du fichier en tant que base64
                     reader.readAsDataURL(fileInput.files[0]);
                     //alert(picture);
                     
     
                 }else{
                     alert("Vous devez selectionner une image dans l'un des formats : png, jpg, jpeg, gif");
                 }
     
                 pvcontent = "ok";

             });
     
             //Fonction permettant d'envoyer l'image au format base64 sur le le reseau
             function send() {
                 //On vériifie si l'utilisateur a selectionné le fichier dans le bon format
                if (pvcontent==""){
                    alert("Veuillez selectionner un fichier !\nSi vous avez l'avez deja fait, alors reesayez apres 05 secondes le temps que l'OCR termine son traitement.");
                }
                else{
                    //console.log("ici datas fonction send", pvcontent);
                    console.log("dans le send et ouverture du modal");
                    //Supprime les candidats existants
                    //loadModal();
                        upload();
                    }
     
             }
             
             function preparer(){
                var candidat_s = document.querySelector('input[name="candidat"]:checked').value;
                if(candidat_s){

                    //pvcontent.code = code.substring(0,code.indexOf(':'))+':'+candidat_s;
                    $('#largeModal').modal('hide');
                    $('.a.fa-upload').trigger("click");
                    pvcontent.code = pvcontent.code + candidat_s;
                    pvcontent.scrutateur = pvcontent.scrutateur + candidat_s;
                    console.log("le pv qu'on send...", pvcontent);
                    upload();
                }
            }

             function upload(){
                if(pvcontent != ""){    
                    $.ajax({
                        type: "POST",
                        async: false,
                        url: "http://localhost:3000/api/ComputePV",
                        data: pvcontent,
                        success: function(result){alert("Success");},
                        error: function(e,r,s){alert("erreur :"+e.toSource());console.log("erreur :",e);}
                    });
                }else{
                    alert("Vous n'avez choisis aucun candidat")
                }
                
             }

            function createRadioElement(value) {
                console.log("Yo");
                var aff = value;
                if (value=="ORGANISM") aff = data[0].session.organism;
                var radioHtml = '<input type="radio" name = "candidat" value= "' + value + '" />' + aff +'<br>';

                var radio = document.createElement('div');
                radio.innerHTML = radioHtml;

                document.getElementById('radioFragment').appendChild(radio);

                //return radioFragment.firstChild;
            }

            function loadModal(){
                console.log("dans load modal");
                    
                $('#largeModal').modal('show');
                //var candidat_s = document.querySelector('input[name="candidat"]:checked').value;
                //return candidat_s;
                //console.log("apres load modal");
                //console.log("modal", $('#largeModal'));
                //alert("modal"+$('#largeModal'));
                
                $(".btn.btn-default.kv-fileinput-upload").css("display", "none");
                //console.log($(".btn.btn-default.kv-fileinput-upload"));
                //alert($(".btn.btn-default.kv-fileinput-upload")[0]);

            }
            //$('#largeModal').modal('show');
              //  console.log("modal normal", $('#largeModal'));
                //alert("modal normal"+$('#largeModal'));
         </script>

</html>